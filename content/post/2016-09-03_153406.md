+++
banner = "banners/atlassian-dragon-slayer-t-shirt.jpg"
categories = ["技術"]
date = "2016-09-03T15:34:07+09:00"
draft = true
slug = "how-to-get-atlassian-dragon-slayer-t-shirt"
tags = ["Atlassian"]
title = "Atlassian から無料でTシャツをもらう方法、あるいはドラゴンの倒し方"

+++

仕事で Atlassian 製品を使っていて、個人的にも便利なタスク・ドキュメント管理に欲しいな、と思い、
[Atlassian のスターターライセンスについてのドキュメント](https://ja.atlassian.com/licensing/starter#aboutthestarterprogram-8)を読んでいた。

する気になるフレーズが目に入った。 **「ドラゴンズレアとは何ですか？」** ──

> 6 つのスターター ライセンスの統合スイートをセットアップすると素晴らしい結果になりますが、セットアップ手順は複雑で時間がかかります。アトラシアンでは、アトラシアン アプリケーション スイートを統合するため方法をドラゴンズレアという説明書にまとめました。また、この困難だけれども素晴らしい旅を完了された方全員向けに、限定版アトラシアン ドラゴン スレイヤー T シャツを提供しています。今すぐ冒険を始めましょう! 勇気がある方はドラゴンに立ち向かいましょう!

せっかくもらえるもんなら、とドラゴン退治をすることにした。

## 環境要件 ##

ドキュメントには「最低 3 GB の RAM と 500 MB のアプリケーションファイル用の空き容量」とある。

しかし、実際にやってみたところ 3 GB では全てのアプリケーションを立ち上げることが出来なかった。
最終的に 6 つのアプリケーションを稼動させることになるのだが、 5 つが限界だった。
**最低 RAM は 4 GB は必要** だと思う。

またディスク容量に関しては、まっさらな環境に諸々構築したあとの総使用量が 6 GB 程だった。
こちらも **最低ストレージは 10 GB は必要** だと思う。

自分は [Google Cloud Platform](https://cloud.google.com/) を利用して構築した。
Google Compute Engine の `vCPU x 1` (メモリ 3.75 GB)の標準インスタンスを使ったが、
前述の通りメモリが足りなくなってしまったので、 `vCPU x 2` (メモリ 7.5 GB)のインスタンスを使う方がよいと思う。

OS は **Debian GNU/Linux 8 (jessie)** を使用した。

## Here Be Dragons ##

それでは [ドキュメント](https://confluence.atlassian.com/display/ATLAS/Here+Be+Dragons) に従って冒険を始めよう。

基本的には書かれてある通りにやればいいだけなのだが、いくつか自分が躓いたポイントがあるので紹介していきたい。

### Dragons Stage 1 - Install JIRA ###

#### Step 1. Install Java ####

まず Java を用意しなければならないのだが、なんと **Oracle JDK 1.7.x** でなければならない。
[1.7 系はすでにサポートが終了している](http://www.oracle.com/technetwork/jp/java/eol-135779-ja.html)のだが、
このクエストではこのバージョンしか想定していないようなので、大人しく従っておく。

``` bash
wget --header "Cookie: oraclelicense=accept-securebackup-cookie" http://download.oracle.com/otn-pub/java/jdk/7u79-b15/jdk-7u79-linux-x64.tar.gz
```

Debian で Oracle Java を利用するには [JavaPackage - Debian Wiki](https://wiki.debian.org/JavaPackage "JavaPackage -
Debian Wiki") にあるような作業が必要になる。

``` bash
sudo sed -i 's/deb http:\/\/httpredir.debian.org\/debian\/ jessie main/deb http:\/\/httpredir.debian.org\/debian\/jessie main contrib/' /etc/apt/sources.list
sudo apt-get update -y && sudo apt-get install -y libgl1-mesa-glx libfontconfig1 libxslt1.1 libxtst6 libxxf86vm1 libgtk2.0-0 java-package
make-jpkg jdk-7u79-linux-x64.tar.gz
sudo dpkg -i oracle-java7-jdk_7u79_amd64.deb
```

#### Step 2. Install your PostgreSQL Database Server ####

こちらも **8.4.x.** というバージョン指定がある。
Java と同様に既に [サポート終了](https://www.postgresql.org/support/versioning/) しているため、
Debian のリポジトリでは配布されていない。
そのため、リポジトリを追加してからインストールする必要がある。

``` bash
sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt/ $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
sudo apt-get update -y && sudo apt-get upgrade -y && sudo apt-get install -y postgresql-8.4
```

#### Step 3. Create your JIRA Database in PostgreSQL ####

Atlassian 製品はデータベースとして MySQL や PostgreSQL を利用出来る。
ただ、日本語や絵文字などマルチバイト文字を扱う場合は PostgresSQL を使うのが無難なようだ( [参考](https://confluence.atlassian.com/jirakb/jira-does-not-work-with-emoji-4-byte-characters-429919955.html) )。

個人的にあまり馴染みがないのだけれど、このドラゴンズレアでも PostgreSQL が指定されているので従っておく。

``` bash
sudo -u postgres createuser -S -d -r -P -E jirauser
# パスワード入力
sudo -u postgres createdb --owner jirauser --encoding utf8 jira
```

#### Step 4. Install JIRA ####

JIRA のバージョンも指定されている。 **6.3.15** を使う必要がある。

``` bash
wget https://www.atlassian.com/software/jira/downloads/binary/atlassian-jira-6.3.15-x64.bin
chmod a+x atlassian-jira-6.3.15-x64.bin
sudo ./atlassian-jira-6.3.15-x64.bin
```

JIRA にはインストーラーがついているので簡単。


### Step 5. Set Up JIRA, Step 6. Set up a Project and Create your JIRA Dashboard ###

あとはドキュメントに従って Web UI 上で操作を行えばよい。

もしかすると、以下のようなよく分からないエラーに遭遇するかもしれない。

```
let.ServletException: javax.servlet.jsp.JspTagException: Soy rendering failed for template '%s'.
説明 The server encountered an internal error that prevented it from fulfilling this request.

例外

org.apache.jasper.JasperException: javax.servlet.ServletException: javax.servlet.jsp.JspTagException: Soy rendering failed for template '%s'.
```

環境依存なのか、言語を日本語にしていた影響なのか分からないが、エラーが発生したらブラウザをリロードすれば大体直っていた。

### Dragons Stage 2 - JIRA Add-Ons ###

ドキュメントに従うだけで特に問題はないが、 Capture for JIRA を動かそうとしたときに以下のエラーが出ていた。

> Your Bonfire license has expired. Please visit My Atlassian to renew

ボンファイアとはなんのこったい、と思ったのだが、どうやら Capture for JIRA のことらしい。
インストール後のアクティベーションが正常に終わっていなかったようだった。
改めて管理画面から評価用ラインセンスを払い出してことなきを得た。

### Dragons Stage 3 - Install Confluence ###

#### Step 1. Create your Confluence Database in PostgreSQL ####

JIRA のときと同様に行う。

``` bash
sudo -u postgres createuser -S -d -r -P -E confuser
sudo -u postgres createdb --owner confuser --encoding utf8 confluence
```

